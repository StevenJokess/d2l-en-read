

<!--
 * @version:
 * @Author:  StevenJokes https://github.com/StevenJokes
 * @Date: 2020-07-15 00:11:06
 * @LastEditors:  StevenJokes https://github.com/StevenJokes
 * @LastEditTime: 2020-07-15 00:36:14
 * @Description:
 * @TODO::
 * @Reference:https://zh.d2l.ai/chapter_natural-language-processing/word2vec.html
 * http://preview.d2l.ai/d2l-en/master/chapter_natural-language-processing-pretraining/word2vec.html
-->

# 词嵌入

自然语言是一个复杂的系统，我们用它来表达意思。在这个系统中，词语是语言意义的基本单位。顾名思义，单词 vector 是用来表示单词的矢量。它也可以看作是一个词的特征向量。将单词映射到实数向量的技术也称为单词嵌入。在过去的几年中，嵌入词逐渐成为自然语言处理的基础知识。

## 为何不采用one-hot向量

我们在“循环神经网络的从零开始实现”一节中使用one-hot向量表示词（字符为词）。回忆一下，假设词典中不同词的数量（词典大小）为 N ，每个词可以和从0到 N−1 的连续整数一一对应。这些与词对应的整数叫作词的索引。假设一个词的索引为 i ，为了得到该词的one-hot向量表示，我们创建一个全0的长为 N 的向量，并将其第 i 位设成1。这样一来，每个词就表示成了一个长度为 N 的向量，可以直接被神经网络使用。

虽然one-hot词向量构造起来很容易，但通常并不是一个好选择。一个主要的原因是，one-hot词向量无法准确表达不同词之间的相似度，如我们常常使用的余弦相似度。对于向量 x,y∈Rd ，它们的余弦相似度是它们之间夹角的余弦值

TODO:MATH

由于任何两个不同词的one-hot向量的余弦相似度都为0，多个不同词之间的相似度难以通过one-hot向量准确地体现出来。

word2vec工具的提出正是为了解决上面这个问题 [1]。它将每个词表示成一个定长的向量，并使得这些向量能较好地表达不同词之间的相似和类比关系。word2vec工具包含了两个模型，即跳字模型（skip-gram）[2] 和连续词袋模型（continuous bag of words，CBOW）[3]。接下来让我们分别介绍这两个模型以及它们的训练方法。

## 跳字模型

跳字模型假设基于某个词来生成它在文本序列周围的词。举个例子，假设文本序列是“the”“man”“loves”“his”“son”。以“loves”作为中心词，设背景窗口大小为2。如图10.1所示，跳字模型所关心的是，给定中心词“loves”，生成与它距离不超过2个词的背景词“the”“man”“his”“son”的条件概率，即

P(``the",``man",``his",``son"∣``loves").

假设给定中心词的情况下，背景词的生成是相互独立的，那么上式可以改写成

P(``the"∣``loves")⋅P(``man"∣``loves")⋅P(``his"∣``loves")⋅P(``son"∣``loves").

图 10.1 跳字模型关心给定中心词生成背景词的条件概率

在跳字模型中，每个词被表示成两个 d 维向量，用来计算条件概率。假设这个词在词典中索引为 i ，当它为中心词时向量表示为 vi∈Rd ，而为背景词时向量表示为 ui∈Rd 。设中心词 wc 在词典中索引为 c ，背景词 wo 在词典中索引为 o ，给定中心词生成背景词的条件概率可以通过对向量内积做softmax运算而得到：

TODO:MATH

其中词典索引集 V={0,1,…,|V|−1} 。假设给定一个长度为 T 的文本序列，设时间步 t 的词为 w(t) 。假设给定中心词的情况下背景词的生成相互独立，当背景窗口大小为 m 时，跳字模型的似然函数即给定任一中心词生成所有背景词的概率

TODO:MATH

这里小于1或大于 T 的时间步可以被忽略。

### 训练跳字模型

跳字模型的参数是每个词所对应的中心词向量和背景词向量。训练中我们通过最大化似然函数来学习模型参数，即最大似然估计。这等价于最小化以下损失函数：

TODO:MATH

如果使用随机梯度下降，那么在每一次迭代里我们随机采样一个较短的子序列来计算有关该子序列的损失，然后计算梯度来更新模型参数。梯度计算的关键是条件概率的对数有关中心词向量和背景词向量的梯度。根据定义，首先看到

TODO:MATH

通过微分，我们可以得到上式中 vc 的梯度

TODO:MATH

它的计算需要词典中所有词以 wc 为中心词的条件概率。有关其他词向量的梯度同理可得。

训练结束后，对于词典中的任一索引为 i 的词，我们均得到该词作为中心词和背景词的两组词向量 vi 和 ui 。在自然语言处理应用中，一般使用跳字模型的中心词向量作为词的表征向量。

## 连续词袋模型

连续词袋模型与跳字模型类似。与跳字模型最大的不同在于，连续词袋模型假设基于某中心词在文本序列前后的背景词来生成该中心词。在同样的文本序列“the”“man”“loves”“his”“son”里，以“loves”作为中心词，且背景窗口大小为2时，连续词袋模型关心的是，给定背景词“the”“man”“his”“son”生成中心词“loves”的条件概率（如图10.2所示），也就是

TODO:MATH

图 10.2 连续词袋模型关心给定背景词生成中心词的条件概率

因为连续词袋模型的背景词有多个，我们将这些背景词向量取平均，然后使用和跳字模型一样的方法来计算条件概率。设 vi∈Rd 和 ui∈Rd 分别表示词典中索引为 i 的词作为背景词和中心词的向量（注意符号的含义与跳字模型中的相反）。设中心词 wc 在词典中索引为 c ，背景词 wo1,…,wo2m 在词典中索引为 o1,…,o2m ，那么给定背景词生成中心词的条件概率

TODO:MATH

为了让符号更加简单，我们记 Wo={wo1,…,wo2m} ，且 v¯o=(vo1+…+vo2m)/(2m) ，那么上式可以简写成

TODO:MATH

给定一个长度为 T 的文本序列，设时间步 t 的词为 w(t) ，背景窗口大小为 m 。连续词袋模型的似然函数是由背景词生成任一中心词的概率

TODO:MATH

## 训练连续词袋模型

训练连续词袋模型同训练跳字模型基本一致。连续词袋模型的最大似然估计等价于最小化损失函数

TODO:MATH

注意到：

TODO:MATH

通过微分，我们可以计算出上式中条件概率的对数有关任一背景词向量 voi （ i=1,…,2m ）的梯度

TODO:MATH

有关其他词向量的梯度同理可得。同跳字模型不一样的一点在于，我们一般使用连续词袋模型的背景词向量作为词的表征向量。

## 小结

* 词向量是用来表示词的向量。把词映射为实数域向量的技术也叫词嵌入。
* word2vec包含跳字模型和连续词袋模型。跳字模型假设基于中心词来生成背景词。连续词袋模型假设基于背景词来生成中心词。

## 练习

1. 每个梯度的计算复杂度是多少？如果字典包含大量的单词，会有什么问题？
1. 英语中有一些固定短语是由多个单词组成的，比如“ new york”。你如何训练他们的词汇向量？提示: 参见 Word2vec 论文[2]中的第4节。
1. 让我们以跳字模型为例来思考 word2vec 模型的设计。在跳字模型中，两个词向量的内积和余弦距离之间的关系是什么？对语义相近的一对词来说，为什么它们的词向量的余弦相似度可能会高？
