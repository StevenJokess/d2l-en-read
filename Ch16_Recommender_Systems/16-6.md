

<!--
 * @version:
 * @Author:  StevenJokes https://github.com/StevenJokes
 * @Date: 2020-07-30 20:37:00
 * @LastEditors:  StevenJokes https://github.com/StevenJokes
 * @LastEditTime: 2020-08-21 19:31:24
 * @Description:MT,improve
 * @TODO::
 * @Reference:http://preview.d2l.ai/d2l-en/master/chapter_recommender-systems/neumf.html
-->

# 个性化排名的神经协同过滤

这一部分超越了显式反馈，介绍了带有隐式反馈的推荐的神经协同过滤框架。隐式反馈在推荐系统中普遍存在。诸如点击、购买和手表之类的动作是常见的隐式反馈，很容易收集并指示用户的偏好。我们将介绍的这个模型，名为 NeuMF [He et al., 2017b],，是神经矩阵分解的简称，旨在通过隐式反馈解决个性化排名任务。该模型利用神经网络的灵活性和非线性来替代矩阵分解的点积，旨在提高模型的表达能力。具体来说，这个模型是由两个子网络构成的，包括广义矩阵分解和 MLP，并且模拟了来自两个路径的相互作用而不是简单的内部产物。这两个网络的输出被连接起来用于最终的预测得分计算。与 AutoRec 中的评级预测任务不同，该模型根据隐式反馈为每个用户生成一个排名推荐列表。我们将使用最后一节介绍的个性化排名损失来训练这个模型。

## NeuMF模型

如前所述，NeuMF 融合了两个子网络。该 GMF 是一个通用的神经网络版本的矩阵分解，其中输入是用户和项目潜在因素的元素乘积。它由两个神经层组成:

其中⊙表示向量的 Hadamard 乘积。P ∈ rmk，q ∈ Rn k，分别对用户和项潜在矩阵作出响应。P u ∈ r k 是 p 的第 u 行，q i ∈ r k  是 q q 的第 i 行。H 表示输出层的激活函数和重量。Y ^ ui 是用户 u 可能给项目 i 的预测得分。

这种模式的另一个组成部分是 MLP。为了增强模型的灵活性，MLP 子网络不与 GMF 共享用户和项目嵌入。它使用用户和项嵌入的串联作为输入。它具有复杂的连接和非线性的转换，能够简化用户与项目之间复杂的交互。更准确地说，MLP 子网的定义是:

TODO:MATH

其中W ∗，b ∗ 和α∗表示权重矩阵，偏差矢量和激活函数。 denotes ∗ ϕ ∗表示相应层的功能。 z ∗ 表示相应层的输出。

为了融合 GMF 和 MLP 的结果，NeuMF 将两个子网络的最后两层连接起来，创建一个特征向量，可以传递给下一层。然后，输出端被投影到矩阵 h 和一个 s 形激活函数。预测层的表述如下:

TODO:MATH

下图说明了 NeuMF 的模型体系结构。

图16.6.1 NeuMF 模型的示意图

TODO:CODE

## 模型实现

下面的代码实现了NeuMF模型。它由广义矩阵分解模型和具有不同用户和物品嵌入向量的多层感知器组成。MLP的结构是由参数 `nums_hiddens` 控制的。ReLU用作默认的激活函数。

TODO:CODE

## 自定义数据集与负抽样

对于两两排序损失，一个重要的步骤是负抽样。对于每个用户，用户没有与之交互的项都是候选项(未观察到的项)。下面的函数将用户标识和候选项作为输入，并从该用户的候选集中为每个用户随机抽取负项。在培训阶段，模型确保用户喜欢的项目的排名高于她不喜欢的项目或没有交互的项目。

TODO:CODE

## 评估者

在本节中，我们采用时间分割策略来构造训练集和测试集。两个评价措施,包括冲击速度给定切断ℓℓ(Hit@ℓHit@ℓ)和ROC曲线下面积(AUC)是用来评估模型的有效性。命中率在给定位置ℓℓ为每个用户显示推荐的项目是否包括在顶部ℓℓ排名列表。其正式定义如下:

TODO:CODE

1表示一个指标函数,等于1如果地面实况项排名在前ℓ列表,否则等于零。ranku,gu表示用户u在推荐列表中的ground truth项gu的排名(理想排名为1)，m为用户数量。U是用户集。

AUC的定义如下:

式中，I为项集，Su为用户u的候选项。注意，许多其他的评估协议，如精度，召回率和标准化折现累积收益(NDCG)也可以使用。

下面的函数为每个用户计算命中次数和AUC。

TODO:CODE

然后，总命中率和AUC的计算如下：

TODO:CODE

## 训练和评估模型

训练函数定义如下。我们以两两配对的方式训练这个模型。

TODO:CODE

现在，我们可以加载MovieLens 100k数据集并训练模型。由于MovieLens数据集中只有评级，因此会损失一些准确性，所以我们将这些评级分为零和一。如果用户对某项评价，我们认为隐含反馈为1，否则为0。对一个项目进行评级的行为可以被视为一种提供隐式反馈的形式。在这里，我们在`seq-aware`模式下分割数据集，在这种模式下，用户的最新交互项被排除在测试之外。

TODO:CODE

然后我们创建并初始化模型。我们使用一个隐藏大小为10的三层MLP。

TODO:CODE

下面的代码训练了这个模型。

TODO:CODE

## 小结

* 在矩阵分解模型中加入非线性，有利于提高模型的性能和有效性。
* NeuMF是矩阵分解和多层感知器的组合。多层感知器将用户和项目嵌入的连接作为输入。

## 练习

* 改变潜在因素的大小。潜在因素的大小如何影响模型性能?
* 改变MLP的架构(例如，层的数目，每层的神经元数目)来检查它对性能的影响。
* 尝试不同的优化器，学习率和权值衰减率。
* 尝试使用上一节定义的铰链损耗来优化该模型。
