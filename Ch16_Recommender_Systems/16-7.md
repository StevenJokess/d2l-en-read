

<!--
 * @version:
 * @Author:  StevenJokes https://github.com/StevenJokes
 * @Date: 2020-07-30 20:47:04
 * @LastEditors:  StevenJokes https://github.com/StevenJokes
 * @LastEditTime: 2020-08-21 19:17:03
 * @Description:MT, improve
 * @TODO::
 * @Reference:http://preview.d2l.ai/d2l-en/master/chapter_recommender-systems/seqrec.html
-->

# 序列感知的推荐系统

在前面的章节中，我们将推荐任务抽象为一个矩阵完成问题，而没有考虑用户的短期行为。在本节中，我们将介绍一个推荐模型，该模型将按顺序排列的用户交互日志考虑在内。这是一个序列感知的推荐系统 [Quadrana et al., 2018] ，其中的输入是一个有序的，往往有时间标记的过去用户操作列表。最近的一些文献已经证明了合并这些信息在建模用户的时间行为模式和发现他们的兴趣漂移的有用性。

我们将介绍的模型，Caser[Tang & Wang, 2018] ，简称卷积序列嵌入推荐模型，采用卷积神经网络捕捉用户最近活动的动态模式影响。Caser 的主要组成部分包括水平卷积网络和垂直卷积网络，分别用于揭示并级和点级序列模式。点层模式表示历史顺序中单个项目对目标项目的影响，而联合层模式则表示前几个动作对后续目标项目的影响。例如，同时购买牛奶和黄油比只购买其中一种更有可能购买面粉。此外，用户的一般兴趣或长期偏好也在最后一个完全连接的层中进行建模，从而得到更全面的用户兴趣建模。模型的细节描述如下。

## 模型架构

在序列感知推荐系统中，每个用户都与项目集中的某些项目的序列相关联。设 Su=(Su1,...Su|Su|)表示有序序列。Caser 的目标是通过考虑用户的一般喜好和短期意向来推荐产品。假设我们考虑到前面的 L 项，可以构造一个嵌入矩阵来表示时间步长 t 的前一个交互:

TODO:MATH

其中Q∈Rn×k表示项嵌入，qi表示第i行。 E（u，t）∈RL×k可用于推断用户uu在时间步tt处的瞬时兴趣。 我们可以将输入矩阵E（u，t）视为图像，这是后续两个卷积分量的输入。

水平卷积层具有d个水平滤波器Fj∈Rh×k，1≤j≤d，h ＝ {1，...，L}Fj∈Rh×k，1≤j≤d，h ＝ {1 ，。 ...，L}，并且垂直卷积层具有d'd'个垂直滤波器Gj∈RL×1,1≤j≤d'。 经过一系列的卷积和池运算后，我们得到两个输出：

TODO:MATH

其中o∈Rd为水平卷积网络的输出，o '∈Rkd '为垂直卷积网络的输出。为了简单起见，我们省略了卷积和池操作的细节。它们被连接并馈入一个完全连接的神经网络层，以获得更高级的表示。

TODO:MATH

其中W∈Rk×(d+kd’)为权矩阵，b∈Rk为偏置。学习的向量z∈Rk是用户短期意图的表示。

最后，预测函数将用户的短期偏好和一般偏好结合在一起，定义为:

y ^外的= vi⋅(z, pu)⊤+ b“,

其中V∈Rn x 2kV∈Rn x 2k是另一项嵌入矩阵。b '∈Rn为项目具体偏差。P∈Rm * k是用户一般喜好的用户嵌入矩阵。pu∈Rk为PP的uth行，vi∈R2k为V的ith行。

该模型可以通过BPR或铰链损失来学习。Caser的架构如下图所示:

图16.7.1 Caser模型实现图

我们首先导入所需的库。

## 模型实现

下面的代码实现了Caser模型。它由垂直卷积层、水平卷积层和全连接层组成。

TODO:CODE

## 具有负抽样的顺序数据集

要处理顺序交互数据，我们需要重新实现Dataset类。下面的代码创建了一个名为SeqDataset的新数据集类。在每个示例中，它输出用户标识，前一个L作为序列交互条目，下一个L作为目标交互条目。下图演示了一个用户的数据加载过程。假设这个用户喜欢8部电影，我们按照时间顺序组织这8部电影。最新的电影被省略为测试项。对于剩下的7部电影，我们可以得到3个训练样本，每个样本包含5个(L=5)电影的序列，其后续项作为目标项。在定制的数据集中也包含负样本。

图16.7.2数据生成过程的图示

TODO:CODE

## 加载MovieLens 100K数据集

然后，我们以顺序感知模式读取和拆分MovieLens 100K数据集，并使用上面实现的顺序数据加载器加载训练数据。

TODO:CODE

训练数据结构如上所示。第一个元素是用户标识，下一个列表表示该用户喜欢的最后5个项目，最后一个元素是该用户喜欢的5个项目之后的项目。

## 训练模型

现在，让我们训练模型。在上一节中，我们使用与NeuMF相同的设置，包括学习率，优化器和k，以使结果具有可比性。

TODO:CODE

## 小结

* 推测用户的短期和长期兴趣，可以更有效地预测下一个他喜欢的项目。
* 卷积神经网络可以从序列交互中获取用户的短期兴趣。

## 练习

1. 通过移除一个水平和垂直卷积网络来进行消融研究，哪个部分更重要?
1. 改变超参数L。更长的历史交互作用是否带来更高的准确性?
1. 除了我们上面介绍的序列感知的推荐任务外，还有一种类型的序列感知的推荐任务，称为基于会话的推荐[Hidasi et al.， 2015]。你能解释一下这两项任务的区别吗?
