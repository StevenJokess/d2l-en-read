

<!--
 * @version:
 * @Author:  StevenJokess https://github.com/StevenJokess
 * @Date: 2020-07-30 18:35:09
 * @LastEditors:  StevenJokess https://github.com/StevenJokess
 * @LastEditTime: 2020-07-30 18:44:50
 * @Description:MT
 * @TODO::
 * @Reference:http://preview.d2l.ai/d2l-en/master/chapter_computer-vision/multiscale-object-detection.html
-->

# 多尺度目标检测

在13.4节中，我们生成了以输入图像的每个像素为中心的多个锚定框。这些锚定框用于对输入图像的不同区域进行采样。然而，如果锚定框是以图像的每个像素为中心生成的，那么很快就会有太多的锚定框供我们计算。例如，我们假设输入图像的高度和宽度分别为561和728像素。如果以每个像素为中心生成五个不同形状的锚定框，则需要预测并标记超过两百万个锚定框(561×728×5)。

减少锚箱的数量并不困难。一种简单的方法是对输入图像中的一小部分像素进行均匀采样，然后生成以采样像素为中心的锚定框。此外，我们可以在多个尺度上生成不同数量和大小的锚定框。请注意，较小的物体比较大的物体更有可能放置在图像上。在这里，我们将使用一个简单的例子: 形状为111、1212和222的物体在形状为222的图像上可能有4、2和1个可能的位置。因此，当使用较小的锚定框检测较小的目标时，我们可以对更多的区域进行采样; 当使用较大的锚定框检测较大的目标时，我们可以对较少的区域进行采样。

为了演示如何在多个尺度上生成锚定框，让我们先读一张图片。它的高度和宽度为561×728像素。

TODO:CODE

在6.2节中，CNN 卷积神经网络的2 d 数组输出被称为特征映射。通过定义特征映射的形状，可以确定任意图像上均匀采样的锚定盒的中点。

函数 display _ anchors 在下面定义。我们要生成锚箱锚集中在每个单位(像素)的特征地图 fmap。由于锚箱中的坐标轴 x x y 是用特征映射的宽度和高度来划分的，因此可以用0到1之间的值来表示特征映射中锚箱的相对位置。由于锚点中点与特征映射图上的所有单元重叠，任何图像上锚点中点的相对空间位置必须具有均匀的分布。具体来说，当特征映射的宽度和高度分别设置为 fmap _ w 和 fmap _ h 时，该函数将对 fmap _ h 行和 fmap _ w 列的像素进行均匀采样，并将它们作为中点来生成大小为 s (我们假设列表的长度为1)和不同宽高比(比)的锚定框。

TODO:CODE

我们将首先集中于小物体的检测。为了便于显示时区分，不同中点的锚定框不重叠。我们假设锚定框的大小为0.15，特征映射的高度和宽度为4。我们可以看到，图像上4行4列的锚定框中点分布均匀。

TODO:CODE

我们打算将特征映射的高度和宽度减少一半，并使用一个更大的锚定框来检测较大的物体。当大小设置为0.4时，一些锚定框的区域之间会发生重叠。

TODO:CODE

最后，我们将把feature map的高度和宽度减半，并将锚框的大小增加到0.8。现在锚框的中点就是图像的中心。

TODO:CODE

因为我们已经在多个尺度上生成了不同大小的锚盒，所以我们将使用它们来检测不同尺度下不同大小的对象。现在我们将介绍一种基于卷积神经网络(CNNs)的方法。

在一定的尺度下，假设我们基于cici特征图生成具有不同中点的锚盒h×wh×w组，形状为h×wh×w，每组锚盒个数为aa。例如，在实验的第一个尺度中，我们基于10个(通道数)形状为4×44×4的feature maps生成了16组具有不同中点的锚盒，每组包含3个锚盒。接下来，每个锚定框都被标上了类别和基于地真边界框的分类和位置的偏移量。在当前尺度下，目标检测模型需要根据输入图像预测不同中点的锚盒h×wh×w组的类别和偏移量。

我们假设ci特征图是基于输入图像的CNN的中间输出。由于每个要素地图的h×w空间位置不同，因此同一位置将具有ci单位。根据第6.2节中对接收场的定义，在相同空间位置的特征图的ci单位在输入图像上具有相同的接收场。因此，它们在相同的接收场中代表输入图像的信息。因此，我们可以将相同空间位置处的特征图的ci单位转换为以该位置为中点生成的a锚框的类别和偏移。不难看出，从本质上讲，我们使用输入图像在某个接受域中的信息来预测靠近输入图像中域的锚框的类别和偏移。

当不同图层的特征图在输入图像上具有不同大小的接收场时，它们将用于检测不同大小的对象。例如，我们可以设计一个网络，使特征图中每个单元的接收区域更宽，更靠近输出层，以检测输入图像中尺寸较大的对象。

我们将在以下部分中实现多尺度目标检测模型。

## 小结

* 我们可以在多个尺度上生成不同数量和大小的锚盒来检测多个尺度上不同大小的目标。
* 特征图的形状可以用来确定锚盒的中点，锚盒可以统一采样任何图像。
* 我们使用来自某个接受域的输入图像的信息来预测图像上靠近该域的锚框的类别和偏移量。

## 练习

1. 对于一个输入图像，设1×ci×h×w为特征图的形状，ci、h、wci、h、w为特征图的数量、高度、宽度。你能想到什么方法来将这个变量转换为锚框的类别和偏移量?输出的形状是什么?
