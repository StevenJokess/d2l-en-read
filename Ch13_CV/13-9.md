

<!--
 * @version:
 * @Author:  StevenJokes https://github.com/StevenJokes
 * @Date: 2020-07-30 19:15:10
 * @LastEditors:  StevenJokes https://github.com/StevenJokes
 * @LastEditTime: 2020-07-30 19:25:06
 * @Description:MT
 * @TODO::
 * @Reference:http://preview.d2l.ai/d2l-en/master/chapter_computer-vision/semantic-segmentation-and-dataset.html
-->

# 语义分割和数据集

在前面关于对象检测问题的讨论中，我们只使用矩形边框来标记和预测图像中的对象。在本节中，我们将讨论语义分割，它试图将图像分割成具有不同语义类别的区域。这些语义区域在像素级标记和预测对象。图13.9.1所示为语义分割后的图像，区域分别标注为“dog”、“cat”和“background”。可以看到，与对象检测相比，语义分割使用像素级边界标记区域，以获得更大的精度。

图13.9.1语义分割的图像，区域标记为“狗”，“猫”和“背景”。

## 图像分割和实例分割

在计算机视觉领域，有两种与语义分割相关的重要方法：图像分割和实例分割。 在这里，我们将这些概念与语义分割区分开来，如下所示：

* 图像分割将图像分为几个组成区域。 该方法通常使用图像中像素之间的相关性。 在训练期间，图像像素不需要标签。 但是，在预测期间，此方法不能确保分割的区域具有我们想要的语义。 如果我们在9.10中输入图像，则图像分割可能会将狗分为两个区域，一个区域覆盖狗的嘴和眼睛，其中黑色是突出的颜色，另一个区域覆盖狗的其余部分，其中黄色是突出的颜色。
* 实例分割也称为同时检测和分割。 此方法尝试识别图像中每个对象实例的像素级区域。 与语义分割相反，实例分割不仅区分语义，而且区分不同的对象实例。 如果图像包含两只狗，则实例分割将区分哪些像素属于哪只狗。

## Pascal VOC2012语义分割数据集

在语义分割领域，一个重要的数据集是Pascal VOC2012。为了更好地理解这个数据集，我们必须首先导入实验所需的包或模块。

TODO:CODE

原始站点可能不稳定，因此我们从镜像站点下载数据。存档文件大约有2gb，所以需要一些时间下载。解压存档之后，数据集位于。/数据/ VOCdevkit VOC2012路径。

去. ./data/VOCdevkit/VOC2012来查看数据集的不同部分ImageSets/分割路径包含指定训练和测试示例的文本文件。JPEGImages和SegmentationClass路径分别包含示例输入图像和标签。这些标签也是图像格式的，与它们对应的输入图像具有相同的尺寸。在标签中，相同颜色的像素属于相同的语义类别。下面定义的read_voc_images函数将所有输入图像和标签读取到内存中。

TODO:CODE

我们绘制前5个输入图像及其标签。在标签图像中，白色代表边框，黑色代表背景。其他颜色对应不同的类别。

TODO:CODE

接下来，我们在标签及其标签类别中列出每个RGB颜色值。

TODO:CODE

定义了上述两个常数后，我们可以很容易地找到标签中每个像素的类别索引。

TODO:CODE

例如，在第一个示例图像中，飞机前部的类别索引为1，而背景的索引为0。

TODO:CODE

## 数据预处理

在前面的章节中，我们缩放了图像以使它们适合模型的输入形状。在语义分割中，该方法需要我们重新映射预测的像素类别到原始大小的输入图像。精确地做到这一点是非常困难的，特别是在具有不同语义的分段区域中。为了避免这个问题，我们裁剪图像来设置尺寸，并且不缩放它们。具体来说，我们使用图像增强中使用的随机裁剪方法来从输入图像及其标签中裁剪相同的区域。

TODO:CODE

## 用于自定义语义分割的数据集类

我们使用Gluon提供的继承数据集类来定制语义分割数据集类VOCSegDataset。通过实现剩余的getitem__函数，我们可以使用索引idx和来自数据集的每个像素的类别索引任意地访问输入图像。由于数据集中的一些图像可能比随机裁剪指定的输出尺寸小，我们必须使用自定义过滤器函数来删除这些示例。此外，我们定义normalize_image函数来规范化输入图像的三个RGB通道。

TODO:CODE

## 读取数据集

使用自定义的VOCSegDataset类，我们创建了训练集和测试集实例。假设随机裁剪操作输出的图像形状为320×480。下面，我们可以看到训练和测试集中保留的示例数量。

TODO:CODE

我们将批处理大小设置为64，并为训练和测试集定义迭代器。 打印第一个小批量的形状。 与图像分类和对象识别相反，这里的标签是三维数组。

TODO:CODE


## 把所有东西放在一起

最后，我们定义一个load_data_voc函数，它下载并加载这个数据集，然后返回数据迭代器。

TODO:CODE

## 总结

* 语义分割着眼于如何将图像分割成具有不同语义类别的区域。
* 在语义分割领域，一个重要的数据集是Pascal VOC2012。
* 由于语义分割中的输入图像和标签在像素级上是一一对应的，所以我们将它们随机裁剪成一个固定的大小，而不是缩放。

## 练习

1. 回忆一下我们在13.1节中讨论的内容。在图像分类中使用的图像增强方法中，哪些在语义分割中难以使用?
