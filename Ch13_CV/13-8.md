

<!--
 * @version:
 * @Author:  StevenJokess https://github.com/StevenJokess
 * @Date: 2020-07-30 19:03:41
 * @LastEditors:  StevenJokess https://github.com/StevenJokess
 * @LastEditTime: 2020-07-30 19:14:32
 * @Description:MT
 * @TODO::
 * @Reference:http://preview.d2l.ai/d2l-en/master/chapter_computer-vision/rcnn.html
-->

# 基于区域的 CNNs (r-CNNs)

基于区域的卷积神经网络或具有 CNN 特征的区域(R-CNNs)是一种开创性的方法，它将深度模型应用于目标检测。在这一部分，我们将讨论 R-CNN 以及它们的一系列改进: Fast R-CNN [ Girshick，2015] ，Faster R-CNN [ Ren et al. ，2015] ，Mask R-CNN [ He et al. ，2017a ]。由于篇幅的限制，我们将只讨论这些模型的设计。

R-CNN 模型首先从图像中选择几个提议的区域(例如，锚定框是一种选择方法) ，然后标记它们的类别和包围框(例如，偏移)。然后，他们使用 CNN 进行前向计算，从每个提出的区域中提取特征。然后，我们利用每个区域的特征来预测它们的类别和包围盒。图13.8.1显示了 R-CNN 模型。

具体而言，R-CNN国家名单由四个主要部分组成:

1. 对输入图像进行选择性搜索，以选择多个高质量的建议区域[ Uijlings 等人，2013]。这些拟议的区域一般在多种尺度上进行选择，并具有不同的形状和大小。对每个区域的范畴和地面真值包围盒进行了标记。
1. 选择一个经过预先训练的 CNN，并以截断的形式放置在输出层之前。该算法将每个提出的区域转换为网络所需的输入维数，并利用正向计算输出从提出的区域中提取的特征。
1. 以每个区域的特征和标记类别为例，对多支持向量机进行目标分类训练。在这里，每个支持向量机是用来确定一个例子是否属于某个类别。
1. 以每个区域的特征和标记包围盒为例，训练了一个地面真实包围盒预测的线性回归模型。

虽然 R-CNN 模型使用预先训练的 CNNs 有效地提取图像特征，但主要缺点是速度慢。你可以想象，我们可以从一张图像中选择数千个提议的区域，这需要 CNN 进行数千次前向计算来执行目标检测。这种巨大的计算负载意味着 r-cnn 在实际应用中并没有得到广泛的应用。

## 快速 R-CNN

R-CNN 模型的主要性能瓶颈是需要独立地提取每个拟合区域的特征。由于这些区域有高度的重叠，独立的特征提取会导致大量的重复计算。快速 R-CNN 改进的 R-CNN 只执行 CNN 前向计算的图像作为一个整体。

图13.8.2快速 R-CNN 模型。

1. 与 R-CNN 模型相比，Fast R-CNN 模型使用整个图像作为 CNN 输入进行特征提取，而不是每个提出的区域。此外，该网络一般训练更新的模型参数。由于输入是一个完整的图像，CNN 的输出形状是1 c h 1 w 11 c h 1 w1。

1. 假设选择性搜索生成nn提出的区域，其不同的形状表示CNN输出中不同形状的感兴趣区域(RoIs)。必须从这些RoIs中提取相同形状的特征(这里我们假设高度为h2h2，宽度为w2w2)。快速R-CNN引入了RoI pooling，将CNN输出和RoIs作为输入，将从每个建议区域提取的特征串接输出，形状为n×c×h2×w2n×c×h2×w2。

1. 采用全连通层将输出形状变换为n×dn×d，其中dd由模型设计确定。

1. 在类别预测时，将全连通层输出的形状再次变换为n×qn×q，使用softmax回归(qq为类别数)。在边界盒预测时，将全连通层输出的形状再次变换为n×4n×4。这意味着我们对每个提出的区域进行分类和边界盒预测。

快速R-CNN中的RoI池化层与我们之前讨论过的池化层有些不同。在一个普通的池化层中，我们设置池化窗口、填充和步幅来控制输出形状。在RoI池化层中，我们可以直接指定每个区域的输出形状，例如将每个区域的高度和宽度指定为h2,w2h2,w2。假设RoI窗口的高度和宽度分别为hh和ww，将该窗口划分为形状为h2×w2h2×w2的子窗口网格。每个子窗口的大小约为(h/h2)×(w/w2)(h/h2)×(w/w2)。子窗口的高度和宽度必须始终为整数，并且使用最大的元素作为给定子窗口的输出。这使得RoI池化层可以从不同形状的RoI中提取出相同形状的特征。

在图13.8.3中，我们选择一个3×33×3的区域作为4×44×4输入的RoI。对于这个RoI，我们使用一个2×22×2的RoI池化层来获得单个的2×22×2输出。将区域划分为4个子窗口，分别包含元素0、1、4和5(5最大);2和6(6是最大的);8和9(9是最大的);和10。

我们使用ROIPooling函数来演示RoI池层计算。假定CNN提取特征X的高度和宽度均为4，并且只有一个通道。

TODO:CODE

假设图像的高度和宽度都为40像素，选择性搜索在图像上生成两个建议区域。每个区域被表示为五个元素:区域的对象类别及其左上角和右下角的x、yx、y坐标。

TODO:CODE

因为X的高度和宽度是1/101/10图像的高度和宽度,提出的两个区域的坐标是乘以0.1根据spatial_scale,然后roi标记在X X(:,:, 0:3 0:3)和X(:,: 1:4, 0:4),分别。最后，我们将两个roi划分为子窗口网格，提取高度和宽度为2的特征。

TODO:CODE

## 更快速 R-CNN

R-CNN 模型的主要性能瓶颈是需要独立地提取每个拟合区域的特征。由于这些区域有高度的重叠，独立的特征提取会导致大量的重复计算。快速 R-CNN 改进的 R-CNN 只执行 CNN 前向计算的图像作为一个整体。

图13.8.4更快的R-CNN模型

图13.8.4显示了Faster R-CNN模型。与快速R-CNN相比，快速R-CNN仅将生成建议区域的方法从选择性搜索更改为区域建议网络。模型的其他部分保持不变。区域提议网络的详细计算过程如下：

1. 我们使用填充为1的3×33×3卷积层来转换CNN输出并将输出通道数设置为cc。这样，CNN从图像中提取的特征图中的每个元素都是长度为cc的新特征。
1. 我们将要素图中的每个元素用作中心，以生成多个具有不同大小和纵横比的锚点框，然后对其进行标记。
1. 我们使用锚框中心处长度为cc的元素的特征来预测其各自锚框的二进制类别（对象或背景）和边界框。
1. 然后，我们使用非最大抑制来去除与“对象”类别预测相对应的相似边界框结果。最后，我们将预测的边界框输出为RoI池层所需的建议区域。

值得注意的是，作为速度更快的R-CNN模型的一部分，区域建议网络是和模型的其余部分一起训练的。另外，更快的R-CNN目标函数包括目标检测中的类别和边界盒预测，以及区域建议网络中锚盒的二值类别和边界盒预测。最后，区域建议网络可以学习如何生成高质量的建议区域，在保持目标检测精度的同时减少建议区域的数量。

## 面具 R-CNN

如果在训练数据上加上图像中每个目标的像素级位置，Mask R-CNN模型可以有效地利用这些详细的标签进一步提高目标检测的精度。

图13.8.5掩模R-CNN模型。

如图13.8.5所示，Mask R-CNN是对更快的R-CNN模型的修改。Mask R-CNN模型将RoI池化层替换为RoI对齐层。这允许使用双线性插值来保留特征地图上的空间信息，使Mask R-CNN更适合于像素级预测。RoI对齐层对所有RoI输出相同形状的特征图。这不仅可以预测RoIs的类别和边框，还允许我们使用额外的完全卷积网络来预测对象的像素级位置。在本章的后面，我们将描述如何使用完全卷积网络来预测图像中的像素级语义。

## 小结

* R-CNN模型选择几个建议区域，使用一个CNN进行正演计算，并从每个建议区域提取特征。然后利用这些特征来预测所建议区域的类别和边界盒。
* 快速R-CNN改进了R-CNN，只对整体图像进行CNN正演计算。它引入了一个RoI池化层，从不同形状的RoI中提取相同形状的特征。
* 更快的R-CNN用区域建议网络代替了在Fast R-CNN中使用的选择性搜索。这减少了提议区域产生的数量，同时确保精确的目标检测。
* Mask R-CNN使用与Faster R-CNN相同的基本结构，但增加了一个完整的卷积层，帮助在像素级定位物体，进一步提高了物体检测的精度。

## 练习

1. 研究与本节相关的GluonCV工具箱中的每个模型的实现。
