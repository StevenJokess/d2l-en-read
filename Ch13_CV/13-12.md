

<!--
 * @version:
 * @Author:  StevenJokes https://github.com/StevenJokes
 * @Date: 2020-07-30 19:47:31
 * @LastEditors:  StevenJokes https://github.com/StevenJokes
 * @LastEditTime: 2020-07-30 20:03:37
 * @Description:MT
 * @TODO::
 * @Reference:http://preview.d2l.ai/d2l-en/master/chapter_computer-vision/neural-style.html
-->

# 神经风格迁移

如果你使用的是社交分享应用程序，或者碰巧是一名业余摄影师，那么你一定熟悉滤镜。过滤器可以改变照片的颜色样式，使背景更清晰或人的脸更白。然而，一个滤镜通常只能改变照片的一个方面。为了创建理想的照片，你经常需要尝试许多不同的滤镜组合。这个过程就像调整模型的超参数一样复杂。

在本节中，我们将讨论如何使用卷积神经网络(CNNs)来自动将一幅图像的样式应用到另一幅图像，这一操作被称为样式转换(style transfer)[ Gatys et al. 2016]。在这里，我们需要两个输入图像，一个内容图像和一个样式图像。我们使用一个神经网络来改变内容图像，使其风格反映了风格图像。在图13.12.1中，内容图像是作者在西雅图附近的 Mount Rainier National Part 拍摄的风景照片。这幅风格画是一幅秋天的橡树油画。输出合成图像在内容图像中保留了物体的整体形状，但运用了风格图像的油画运笔，使整体色彩更加生动。

图13.12.1内容和样式输入图像和样式转换生成的合成图像。

## 技巧

基于 cnn 的风格转移模型如图13.12.2所示。首先，我们初始化复合图像。例如，我们可以将其初始化为内容图像。这个复合图像是样式传输过程中唯一需要更新的变量，即样式传输中需要更新的模型参数。然后，我们选择一个事先训练的 CNN 来提取图像特征。这些模型参数不需要在培训期间更新。深层细胞神经网络使用多个神经层，连续提取图像特征。我们可以选择某些层的输出作为内容特性或样式特性。如果我们使用图13.12.2中的结构，预先训练的神经网络包含三个卷积层。第二层输出图像内容特征，第一层和第三层的输出用作样式特征。接下来，我们使用正向传播(实线方向)来计算样式传递损失函数和反向传播(虚线方向)来更新模型参数，不断更新合成图像。风格转换中使用的损失函数一般包括三个部分: 1。内容丢失用于使合成图像在内容特征方面接近内容图像。图2。采用风格丢失的方法使合成图像在风格特征方面与风格图像近似。图3。总变分损失有助于降低合成图像中的噪声。最后，对模型进行训练，输出样式传递模型参数，得到最终的合成图像。

图13.12.2基于 cnn 的样式转移过程。实线表示正向传播的方向，虚线表示反向传播。

接下来，我们将进行一个实验来帮助我们更好地理解风格转换的技术细节。

## 阅读内容和风格的图像

首先，我们阅读内容和样式图像。通过打印图像坐标轴，我们可以看到它们具有不同的尺寸。

TODO:CODE

TODO:CODE

## 预处理和后处理

下面我们定义图像预处理和后处理的函数。预处理函数对输入图像的三个RGB通道进行归一化，并将结果转换为可以输入到CNN的格式。后处理函数将输出图像中的像素值恢复为原值，然后进行归一化处理。因为图像打印函数要求每个像素都有一个从0到1的浮点值，所以我们使用clip函数将小于0或大于1的值分别替换为0或1。

TODO:CODE

## 特征提取

我们使用在ImageNet数据集上预先训练的VGG-19模型来提取图像特征[1]。

TODO:CODE

为了提取图像内容和风格特征，我们可以在VGG网络中选择特定层的输出。一般来说，输出越接近输入层，就越容易提取图像细节信息。输出距离越远，就越容易提取全局信息。为了防止复合图像从内容图像中保留太多细节，我们选择靠近输出层的VGG网络层来输出图像内容特性。这一层称为内容层。我们还从VGG网络中选择不同层的输出来匹配局部和全局样式。这些被称为样式层。正如我们在7.2节中提到的，VGG网络有5个卷积块。在本次实验中，我们选择了第四个卷积块的最后一个卷积层作为内容层，每个卷积块的第一层作为样式层。我们可以通过打印pretrained_net实例来获得这些层的索引。

TODO:CODE

在特征提取过程中，我们只需要使用从输入层到离输出层最近的内容或样式层的所有VGG层。下面我们构建一个新的网络，net，它只保留了我们需要使用的VGG网络中的层。然后利用网络提取特征。

TODO:CODE

给定输入X，如果简单调用前向计算网(X)，只能得到最后一层的输出。因为我们还需要中间层的输出，所以我们需要执行逐层计算并保留内容和样式层的输出。

TODO:CODE

接下来，我们定义两个函数:get_contents函数获得从内容图像提取的内容特性，而get_styles函数获得从样式图像提取的样式特性。由于我们在训练时不需要改变预训练过的VGG模型的参数，所以我们可以在训练开始前从内容图像中提取内容特征，从风格图像中提取风格特征。由于复合图像是样式转换过程中必须更新的模型参数，因此我们只能在训练时调用extract_features函数来提取复合图像的内容和样式特征。

TODO:CODE

## 定义损失函数

接下来，我们将查看用于样式转换的loss函数。损失函数包括内容损失、样式损失和总变异损失。

### 内容的损失

与线性回归中使用的丢失函数类似，内容丢失使用平方误差函数来度量合成图像和内容图像之间的内容特征差异。平方误差函数的两个输入都是extract_features函数得到的内容层输出。

TODO:CODE

### 风格的损失

与内容丢失类似，样式丢失使用平方误差函数来度量复合图像和样式图像之间的样式差异。为了通过样式层表达样式输出，我们首先使用extract_features函数来计算样式层输出。假定产出1例,cc频道,和hh和ww的高度和宽度,我们可以将输出转换为矩阵XX, cc行和h⋅wh⋅w列。你可以把矩阵XX想象成cc向量x1，…，xcx1，…，xc的组合，它们的长度是hwhw。这里，向量xi代表了二频道的风格特征。格拉姆矩阵的向量XX⊤∈Rc×cXX⊤∈Rc×c元素xijxij行二列jj是向量的内积细细和xjxj。它代表了channel ii与jj的风格特征的相关性。我们使用这种类型的克矩阵来表示样式层的样式输出。你必须注意,当h⋅wh⋅w值很大,这常常会导致大格拉姆矩阵中的值。另外，Gram矩阵的高度和宽度都是通道cc的数量。为了确保样式丢失不受这些值大小的影响，我们定义下面的gram函数，将gram矩阵除以其元素的数量，即c⋅h⋅w。

TODO:CODE

当然，风格损失的平方误差函数的两克矩阵输入是从复合图像和风格图像风格层输出。这里，我们假设样式图像gram_Y的Gram矩阵已经提前计算。

TODO:CODE

### 总方差损失

有时，我们学到的合成图像会有很多高频噪声，尤其是明亮或黑暗的像素。一种常用的降噪方法是全变差去噪。假设xi,jxi,j表示坐标(i,j)(i,j)处的像素值，则总方差损失为:

TODO:MATH

我们尝试使相邻像素的值尽可能相似。

TODO:CODE

### 损失函数

样式转移的损失函数是内容损失、样式损失和总方差损失的加权和。通过调整这些权值超参数，我们可以根据其相对重要性来平衡复合图像中保留的内容、转移的风格和降噪。

### 创建和初始化复合映像

在样式转换中，复合图像是惟一需要更新的变量。因此，我们可以定义一个简单的模型GeneratedImage，并将合成图像作为模型参数。在模型中，前向计算只返回模型参数。

TODO:CODE

接下来，我们定义get_inits函数。该函数创建一个复合图像模型实例，并将其初始化为图像x。样式图像的各个样式层(styles_Y_gram)的克矩阵在训练之前进行计算。

TODO:CODE

### 训练

在模型训练过程中，我们不断提取合成图像的内容特征和风格特征，并计算损失函数。回想一下我们在12.2节中对同步函数如何强制前端等待计算结果的讨论。由于我们每50个epoch只调用asscalar同步函数，因此进程可能会占用大量内存。因此，我们在每个时期都调用waitall同步函数。

如您所见，合成图像保留了内容图像的风景和对象，同时引入了样式图像的颜色。由于图像相对较小，因此细节有些模糊。

为了获得更清晰的合成图像，我们使用更大的图像尺寸：900×600900×600训练模型。我们将之前使用的图像的高度和宽度增加四倍，并初始化较大的合成图像。

TODO:CODE

正如您所看到的，由于图像尺寸较大，每个历元需要更多的时间。如图13.12.3所示，所生成的复合图像由于尺寸较大，保留了更多的细节。复合图像不仅有风格图像那样的大块色彩，而且这些大块还具有画笔笔触的微妙纹理。

图13.12.3 900×600合成图像。

## 小结

* 风格转换中使用的丢失功能一般有三部分:1。内容丢失用于使复合图像在内容特征方面近似于内容图像。2.风格缺失是利用风格特征使复合图像在风格特征上近似于风格图像。3.总变异损失有助于降低合成图像中的噪声。
* 我们可以使用一个预先训练好的CNN来提取图像特征，最小化损失函数来不断更新合成图像。
* 我们使用一个克矩阵来表示样式层的样式输出。

## 练习

1. 当您选择不同的内容和样式层时，输出如何改变?
1. 调整损失函数中的权重超参数。输出保留了更多的内容还是有更少的噪音?
1. 使用不同内容和样式的图像。您可以创建更有趣的复合图像吗?
