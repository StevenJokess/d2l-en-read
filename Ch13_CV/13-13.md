

<!--
 * @version:
 * @Author:  StevenJokess https://github.com/StevenJokess
 * @Date: 2020-07-14 23:22:07
 * @LastEditors:  StevenJokess https://github.com/StevenJokess
 * @LastEditTime: 2020-09-19 20:09:26
 * @Description:MT， improve
 * @TODO::
 * @Reference:http://preview.d2l.ai/d2l-en/master/chapter_computer-vision/kaggle-cifar10.html
-->

# Kaggle 上的图像分类(CIFAR-10)

到目前为止，我们一直在使用 Gluon 的数据包直接获得张量格式的图像数据集。然而，在实践中，图像数据集常常以图像文件的格式存在。在本节中，我们将从原始图像文件开始，一步一步地组织、读取和转换这些文件为张量格式。

我们在13.1节中对 CIFAR-10数据集进行了实验。这是计算机视觉领域的一个重要数据集。现在，我们将应用我们在前面章节中学到的知识来参加 Kaggle 竞赛，这个竞赛解决了 CIFAR-10图像分类问题。比赛的网址是

> https://www.kaggle.com/c/cifar-10

图13.13.1展示了本次比赛网页的信息。为了提交结果，请先在Kaggle网站注册一个账号。

图13.13.1 CIFAR-10图像分类竞赛网页资料。您可以点击“ Data”选项卡访问比赛的数据集。

首先，导入竞赛所需的软件包或模块。

TODO:CODE

## 获取和组织数据集

将比赛数据分为训练集和测试集。训练集包含50,000到50,000张图片。测试套件包含300000300000张图像，其中10000张图像用于评分，另外290000290000张图像包含在内，以防止测试套件的手动标记和提交标记结果。两个数据集中的图像格式都是 PNG 格式，高度和宽度为32像素和三色通道(RGB)。这些图片涵盖了1010个类别: 飞机、汽车、鸟类、猫、鹿、狗、青蛙、马、船和卡车。图9.16的左上角显示了数据集中的一些飞机、汽车和鸟类的图像。

### 下载数据集

登录到Kaggle后，在如图13.13.1所示的CIFAR-10图像分类竞赛网页上，点击“Data”标签，点击“download All”按钮下载数据集。在解压缩下载文件后../data/和解压缩train.7z和test.7z在其中，你会发现整个数据集在以下路径:

* ../data/cifar-10/train/(1 - 50000).png
* ../data/cifar-10/test/(1 - 300000).png
* ../data/cifar-10/trainLabels.csv
* ../data/cifar-10/sampleSubmission.csv

这里的train和test文件夹分别包含训练和测试图像，`trainLabels.csv`有训练图像的标签，`sample_submission.csv`是一个提交示例。

为了便于开始，我们提供了数据集的一个小规模样本:它包含最初的1000张训练图像和5张随机测试图像。要使用Kaggle比赛的完整数据集，您需要将下面的演示变量设置为`False`。

TODO:CODE

### 组织数据集

我们需要组织数据集来促进模型训练和测试。让我们首先从csv文件中读取标签。下面的函数返回一个字典，该字典将不带扩展名的文件名映射到它的标签。

TODO:CODE

接下来,我们定义`reorg_train_valid`函数段验证组从原始训练集。这个函数的参数`valid_ratio`例子验证的数量的比例设置为原始训练集的例子。特别是,让神经网络的图像类的数量最少的例子,和rr比率,然后我们将使用`max(⌊nr⌋,1)`为每个类图像验证集。让我们用`valid_ratio = 0.1`为例。由于原始训练集有`50,000`张图像，因此在调优超参数时，将有$45,000$张图像用于训练并存储在路径“train_valid_test/train”中，而其他$5,000$张图像将作为验证集存储在路径 `"train_valid_test/valid"`中。在整理完数据后，将同一类的图像放在同一个文件夹下，以便我们以后阅读。

TODO:CODE

### 读取数据集

接下来，我们可以创建ImageFolderDataset实例来读取包含原始图像文件的组织数据集，其中每个示例都包含图像和标签。

TODO:CODE

我们在DataLoader中指定已定义的图像增强操作。在训练过程中，我们只使用验证集来评估模型，所以我们需要确保输出的确定性。在预测过程中，我们将在组合训练集和验证集上训练模型，以充分利用所有的标记数据。

TODO:CODE

## 定义模型

这里，我们基于`HybridBlock`类构建剩余块，它与7.6节中描述的实现略有不同。这样做是为了提高执行效率。

TODO:CODE

接下来，我们定义ResNet-18模型。

TODO:CODE

CIFAR-10图像分类挑战使用了10个类别。在训练开始之前，我们将对模型进行Xavier随机初始化。

TODO:CODE

## 定义训练函数

我们将选择模型并根据模型在验证集上的性能来调整超参数。接下来，我们定义模型训练功能训练。我们记录每个时期的训练时间，这有助于我们比较不同模型的时间成本。

TODO:CODE

## 训练和验证模型

现在，我们可以训练和验证模型。可以调整以下超参数。例如，我们可以增加时期数。因为`lr_period`和`lr_decay`分别设置为50和0.1，所以每50个周期后，优化算法的学习率将乘以0.1。为了简单起见，我们在这里只训练一个时期。

CIFAR-10图像分类挑战使用10个类别。在训练开始之前，我们将对模型执行Xavier随机初始化。

TODO:CODE

## 对测试集进行分类并在Kaggle上提交结果

在得到满意的模型设计和超参数后，我们使用所有的训练数据集(包括验证集)对模型进行再训练，对测试集进行分类。

TODO:CODE

执行以上代码后，会得到一个“submission.csv”文件。此文件的格式与Kaggle竞赛要求一致。提交结果的方法类似于:numref:sec_kaggle_house中的方法。

## 小结

* 我们可以创建一个`ImageFolderDataset`实例来读取包含原始图像文件的数据集。
* 我们可以使用卷积神经网络、图像增强和混合编程来参加图像分类竞赛。

## 练习

1. 将完整的CIFAF-10数据集用于Kaggle竞赛。将`batch_size`和纪元数`num_epochs`分别更改为128和100。看看您在这场比赛中可以达到的准确性和排名。
1. 不使用图像增强时可以达到什么精度？
1. 扫描QR码以访问相关讨论，并就社区使用的方法和获得的结果交换意见。您能提出更好的技术吗？
