

<!--
 * @version:
 * @Author:  StevenJokess https://github.com/StevenJokess
 * @Date: 2020-07-29 21:34:28
 * @LastEditors:  StevenJokess https://github.com/StevenJokess
 * @LastEditTime: 2020-10-21 17:14:37
 * @Description:MT, update
 * @TODO::
 * @Reference:http://preview.d2l.ai/d2l-en/master/chapter_recurrent-modern/machine-translation-and-dataset.html
 * https://github.com/d2l-ai/d2l-en/edit/master/chapter_recurrent-modern/machine-translation-and-dataset.md

-->

# 机器翻译和数据集
:label:`sec_machine_translation`

我们已经使用RNN设计语言模型，这是自然语言处理的关键。 另一个旗舰基准是机器翻译，这是序列转导模型的核心问题领域，可将输入序列转换为输出序列。 序列转导模型在各种现代人工智能应用中起着至关重要的作用，将成为本章其余部分和第10节的重点。为此，本节介绍了机器翻译问题及其数据集，稍后将使用它。

机器翻译是指将序列从一种语言自动翻译为另一种语言。 实际上，这个领域可以追溯到数字计算机发明之后的1940年代，特别是考虑到在第二次世界大战中使用计算机来破解语言代码。 几十年来，在使用神经网络进行端到端学习兴起之前，统计方法一直是该领域的主导 :cite:`Brown.Cocke.Della-Pietra.ea.1988,Brown.Cocke.Della-Pietra.ea.1990`。 后者通常被称为神经机器翻译，以使其与统计机器翻译区分开来，统计机器翻译涉及诸如翻译模型和语言模型之类的组件中的统计分析。

强调端到端学习，这本书将重点介绍神经机器翻译方法。 与我们的第8.3节中的语言模型问题（其语料库为一种单一语言）不同，机器翻译数据集由分别为源语言和目标语言的成对文本序列组成。 因此，我们不需要将预处理例程重新用于语言建模，而是需要一种不同的方法来预处理机器翻译数据集。 在下面的内容中，我们将展示如何将预处理的数据加载到小型批次中进行训练。

TODO:CODE

## 读取和预处理数据集

首先，我们[从Tatoeba项目](http://www.manythings.org/anki/)下载一个英法数据集，该数据集由双语句子对组成。数据集中的每一行都是由制表符分隔的一对英文文本序列和已翻译的法文文本序列。注意，每个文本序列可以是一个句子，也可以是由多个句子组成的一段。在这个机器翻译问题中，英语被翻译成法语，英语是源语言，法语是*目标语言*。

TODO:CODE

我们对原始文本数据执行了几个预处理步骤，包括忽略大小写、用空格替换UTF-8非断行空格以及在单词和标点符号之间添加空格。

TODO:CODE

## 标记化

与第8.3节中使用字符标记不同，此处标记是单词或标点符号。以下函数标记文本数据以返回源和目标。每个是令牌列表的列表，其中`source[i]`是源语言中的第ith个句子，而`target[i]`是目标语言中的第ith个句子。为了使后面的训练更快，我们对前num_examples个句子对进行采样。

TODO:CODE

在下面的图中，我们将每个句子的标记数的柱状图可视化。可以看出，一个句子平均包含5个记号，大多数句子的记号少于10个。

TODO:CODE

## 词汇表

由于机器翻译数据集由语言对组成，我们可以分别为源语言和目标语言构建两个词汇表。词级分词法的词汇量明显大于字符级分词法的词汇量。为了缓解这种情况，这里我们将出现次数少于2次的不常见令牌作为相同的未知令牌("<unk>")处理。除此之外，我们还指定了额外的特殊标记，例如用于在小批量中填充(" <pad> ")相同长度的序列，以及用于标记序列的开始("<bos>")或结束("<eos>")。这种特殊标记通常在自然语言处理任务中使用。

TODO:CODE

## 加载数据集

在语言模型中，每个示例都是来自语料库的num_steps长度序列，它可能是句子的一个片段，也可能跨越多个句子。在机器翻译中，一个例子应该包含一对源句和目标句。这些句子可能有不同的长度，而我们需要相同长度的例子来组成一个小批。

解决这个问题的一种方法是，如果一个句子比num_steps长，我们就修剪它的长度，否则用特殊的<pad>标记填充以满足长度。因此，我们可以将任何句子转换为固定长度。

TODO:CODE

现在我们可以将一个句子列表转换为一个(num_example, num_steps)索引数组。我们还记录没有填充标记的每个句子的长度，称为有效长度，这可能被一些模型使用。此外，我们在目标句中添加特殊的“<bos>”和“<eos>”符号，使我们的模型能够知道开始和结束预测的信号。

TODO:CODE

然后我们可以基于这些数组构造小批量。

## 汇总一切

最后，我们定义函数load_data_nmt来返回带有源语言和目标语言词汇表的数据迭代器。

TODO:CODE

让我们来读第一批。

TODO:CODE

## 总结

* 机器翻译是指将一个序列从一种语言自动翻译成另一种语言。
* 使用词级分词法时，词汇量明显大于使用字符级分词法。为了减轻这种情况，我们可以将不常见的令牌视为相同的未知令牌。
* 我们可以截断和填充文本序列，以便所有它们将有相同的长度，以小批量加载。

## 练习

1. 在`load_data_nmt`函数中尝试不同的`num_examples`参数值。这如何影响源语言和目标语言的词汇量?
1. 一些语言的文本，如中文和日文，没有文字边界指示符(如空格)。在这种情况下，单词级的标记法仍然是一个好主意吗?为什么或为什么不?
